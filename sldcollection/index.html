<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SLD Collection Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root { --primary: #0F204B; --secondary: #78BE20; --bg: #f4f7f9; --text-dark: #333; --error: #dc3545; }
    body { background-color: var(--bg); font-family: 'Inter', sans-serif; color: var(--text-dark); padding-bottom: 70px; }
    
    .card-custom { background: white; border-radius: 12px; padding: 20px; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 20px; }
    .section-title { font-size: 0.9rem; text-transform: uppercase; color: var(--primary); font-weight: 700; border-bottom: 2px solid #e9ecef; padding-bottom: 8px; margin-bottom: 15px; }
    .form-label { font-size: 0.85rem; font-weight: 500; color: #555; }
    .val-error { border-color: var(--error) !important; background-color: #fff8f8; }
    .val-msg { color: var(--error); font-size: 0.7rem; font-weight: 700; display: block; margin-top: 2px; }

    .cable-table { width: 100%; font-size: 0.75rem; border-collapse: collapse; text-align: center; }
    .cable-table th { background-color: #e3f2fd; color: var(--primary); padding: 8px 4px; border: 1px solid #dee2e6; vertical-align: middle; white-space: normal; }
    .cable-table td { padding: 4px; border: 1px solid #dee2e6; vertical-align: middle; }
    .cable-table input { width: 100%; text-align: center; border: 1px solid #ced4da; padding: 4px; border-radius: 4px; font-size: 0.8rem; }
    .cable-table input:focus { outline: none; border-color: var(--primary); }
    .cable-table input:read-only { background-color: #f8f9fa; color: #666; }
    
    .hidden-row { display: none; }
    .show-more-btn { font-size: 0.8rem; font-weight: 600; text-decoration: none; cursor: pointer; display: block; margin-top: 10px; text-align: center; }

    .loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.98); z-index: 4000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    
    .nav-tabs-custom { position: fixed; bottom: 0; left: 0; width: 100%; background: white; z-index: 1000; display: flex; justify-content: space-around; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
    .nav-link-custom { border: none; background: transparent; color: #6c757d; font-weight: 600; padding: 8px 15px; border-radius: 20px; cursor: pointer; }
    .nav-link-custom.active { background-color: var(--primary); color: white; }
  </style>
</head>
<body>

<div id="loader" class="loader-overlay">
  <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
  <div class="fw-bold text-muted" id="loaderText">Connecting to Server...</div>
</div>

<div id="loginScreen" class="overlay">
  <div class="card-custom shadow" style="width: 350px;">
    <div class="text-center mb-4"><h3 class="fw-bold" style="color:var(--primary);">SLD Collection</h3></div>
    <div class="mb-3"><label class="form-label">Emp Code</label><input type="text" id="loginEmpCode" class="form-control"></div>
    <div class="mb-3"><label class="form-label">Password</label><input type="password" id="loginPass" class="form-control"></div>
    <button class="btn btn-primary w-100" onclick="attemptLogin()">Login</button>
    <div id="loginMsg" class="text-danger mt-3 text-center small fw-bold"></div>
  </div>
</div>

<div id="app" style="display:none;" class="container pt-3">
  
  <div class="d-flex justify-content-between align-items-center mb-3">
    <small class="text-muted">User: <span id="displayUserName" class="fw-bold text-dark"></span></small>
    <button class="btn btn-sm btn-outline-danger" onclick="logout()">Logout</button>
  </div>

  <div id="tabForm">
    <form id="mainForm">
      <input type="hidden" id="activeEmpCode"><input type="hidden" id="uploaderName" name="uploaderName">
      
      <div class="card-custom">
        <h6 class="section-title">üìç Location Details</h6>
        <div class="row g-3">
          <div class="col-6"><label class="form-label">Zone</label><select name="zone" id="sel-zone" class="form-select form-select-sm" onchange="filterHierarchy('zone')"></select></div>
          <div class="col-6"><label class="form-label">Circle</label><select name="circle" id="sel-circle" class="form-select form-select-sm" onchange="filterHierarchy('circle')"></select></div>
          <div class="col-6"><label class="form-label">Division</label><select name="division" id="sel-div" class="form-select form-select-sm" onchange="filterHierarchy('div')"></select></div>
          <div class="col-6"><label class="form-label">Sub Div</label><select name="subdiv" id="sel-subdiv" class="form-select form-select-sm" onchange="filterHierarchy('subdiv')"></select></div>
          <div class="col-6"><label class="form-label">Substation</label><select name="substation" id="sel-substn" class="form-select form-select-sm" onchange="filterHierarchy('substn')"></select></div>
          <div class="col-12"><label class="form-label text-primary fw-bold">Feeder</label><select name="feeder" id="sel-feeder" class="form-select"></select></div>
        </div>
      </div>

      <div class="card-custom">
        <h6 class="section-title">‚ö° DT Capacity Breakup (Scope)</h6>
        <div class="row g-2" id="kvaInputs">
            <div class="col-4">
                <div class="bg-warning-subtle p-2 rounded border border-warning text-center">
                    <label class="small fw-bold text-danger d-block">PTW</label>
                    <input type="number" class="form-control text-center p-1 kva-scope-in" name="cap_ptw" id="cap_ptw" value="0" min="0" oninput="calculateScope()">
                </div>
            </div>
            </div>
      </div>

      <div class="card-custom">
        <h6 class="section-title">üìä Scope & Status</h6>
        <div class="row g-3">
          <div class="col-6">
            <label class="form-label text-muted">Total Scope</label>
            <input type="number" class="form-control bg-light" id="out-totalScope" value="0" readonly>
          </div>
          <div class="col-6">
            <label class="form-label text-muted">Not In Scope</label>
            <input type="number" class="form-control bg-light" id="out-notInScope" value="0" readonly>
          </div>

          <div class="col-6">
            <label class="form-label text-primary">Installed <span class="text-danger">*</span></label>
            <input type="number" class="form-control" name="totalInstalled" id="in-installed" oninput="calculateScope()">
          </div>
          <div class="col-6">
            <label class="form-label text-primary">Cable Req (DTs) <span class="text-danger">*</span></label>
            <input type="number" class="form-control" name="cableReq" id="in-cableReq" oninput="calculateScope()">
            <div id="err-cableReq" class="val-msg"></div>
          </div>

          <div class="col-12"><hr class="my-1"></div>

          <div class="col-6">
            <label class="form-label fw-bold text-success">Balance Scope</label>
            <input type="number" class="form-control fw-bold text-success bg-light" name="balanceScope" id="out-balanceScope" value="0" readonly>
          </div>
          <div class="col-6">
            <label class="form-label text-primary">Without Cable <span class="text-danger">*</span></label>
            <input type="number" class="form-control" name="withoutCable" id="in-withoutCable" oninput="validateWithoutCable()">
            <div id="err-withoutCable" class="val-msg"></div>
          </div>
        </div>

        <div id="cableDetailsSection" class="mt-4 fade-in" style="display:none;">
            <div class="cable-header p-2 bg-info bg-opacity-10 border border-info rounded-top text-center">
                <h6 class="m-0 text-primary fw-bold small">2. DT Cable Requirement Details</h6>
            </div>
            <div class="table-responsive">
                <table class="cable-table">
                    <thead>
                        <tr>
                            <th style="width:15%">DT CAPACITY (KVA)</th>
                            <th style="width:20%">TOTAL DTS (COUNT)</th>
                            <th style="width:20%">DTS REQ CABLE (COUNT)</th>
                            <th style="width:15%">CABLE SIZE (SQ. MM)</th>
                            <th style="width:15%">TOTAL LENGTH (MTR)</th>
                            <th style="width:15%">AVG LENGTH (MAX 34M)</th>
                        </tr>
                    </thead>
                    <tbody id="cableTableBody">
                        </tbody>
                    <tfoot class="table-light fw-bold">
                         <tr>
                             <td>TOTAL</td>
                             <td id="tbl-sum-count">0</td>
                             <td>-</td>
                             <td>-</td>
                             <td id="tbl-sum-len">0</td>
                             <td>-</td>
                         </tr>
                    </tfoot>
                </table>
            </div>
            <div id="tbl-error-msg" class="val-msg text-center mt-2"></div>
            <div class="text-center">
                <a class="show-more-btn text-primary" onclick="toggleHighCapacity()">
                    <i class="bi bi-chevron-down"></i> Show more rating
                </a>
            </div>
        </div>
      </div>

      <div class="card-custom">
        <h6 class="section-title">üì∑ Proof Documents</h6>
        <div class="mb-3"><label class="form-label">Sign-off Copy <span class="text-danger">*</span></label><input type="file" class="form-control" accept="image/*" onchange="handleImage(this, 'signoffBase64')"></div>
        <div class="mb-3"><label class="form-label">SLD Drawing <span class="text-danger">*</span></label><input type="file" class="form-control" accept="image/*" onchange="handleImage(this, 'sldBase64')"></div>
      </div>

      <button type="button" class="btn btn-primary w-100 py-3 fw-bold shadow-sm mb-5" onclick="submitForm()">Submit Data</button>
    </form>
  </div>
  
  <div class="nav-tabs-custom">
    <button class="nav-link-custom active"><i class="bi bi-ui-checks"></i> Form</button>
  </div>
</div>

<script>
  // =============== CONFIG ===============
  const API_URL = 'https://script.google.com/macros/s/AKfycbwCL0qhkMW9EZvDPCWjKcp1mjKr9Y0BmCNAemItqf6ei4-ap-lV2TNsJiIP1082eT0n/exec'; 
  
  const CABLE_MAP = {
    10:35, 16:35, 25:35, 63:70, 100:120, 160:240, 
    250:400, 315:400, 400:630, 630:1000, 750:1000, 
    800:1000, 1000:1000, 1200:1000, 1500:1000, 2000:1000
  };
  
  const KVA_LIST = [10,16,25,63,100,160,250,315,400,630,750,800,1000,1200,1500,2000];
  let masterData = [], completedFeeders = [], payload = { signoffBase64: null, sldBase64: null };

  window.onload = function() {
    renderKvaInputs();
    renderCableTableRows();
    const saved = localStorage.getItem('sld_creds');
    if(saved) {
       const c = JSON.parse(saved);
       document.getElementById('loginEmpCode').value = c.code;
       document.getElementById('loginPass').value = c.pass;
       attemptLogin();
    } else {
       document.getElementById('loader').style.display = 'none';
    }
  };

  // Section 2: Scope Inputs
  function renderKvaInputs() {
    const container = document.getElementById('kvaInputs');
    KVA_LIST.forEach(k => {
        container.innerHTML += `
        <div class="col-3">
            <div class="text-center">
                <label class="small text-muted d-block" style="font-size:0.7rem;">${k}</label>
                <input type="number" class="form-control text-center p-1 kva-scope-in" name="cap_${k}" value="0" min="0" oninput="calculateScope()">
            </div>
        </div>`;
    });
  }

  // Section 3: Cable Table
  function renderCableTableRows() {
     const tbody = document.getElementById('cableTableBody');
     let html = '';
     KVA_LIST.forEach(k => {
         const isHidden = k >= 750 ? 'hidden-row high-cap' : '';
         html += `
         <tr class="bg-white ${isHidden}">
             <td class="fw-bold">${k}</td>
             <td><input type="number" class="cable-dt-count" data-kva="${k}" placeholder="0" oninput="validateTable()"></td>
             <td><input type="number" class="cable-dt-mirror" id="mirror-${k}" placeholder="0" readonly style="background:#eee;"></td>
             <td><input type="text" class="cable-size" value="${CABLE_MAP[k]}" readonly></td>
             <td><input type="number" class="cable-len" data-kva="${k}" placeholder="0" oninput="validateTable()"></td>
             <td class="fw-bold small cable-avg" id="avg-${k}">0</td>
         </tr>`;
     });
     tbody.innerHTML = html;
  }

  function toggleHighCapacity() {
      document.querySelectorAll('.high-cap').forEach(el => el.classList.toggle('hidden-row'));
      const btn = document.querySelector('.show-more-btn');
      btn.innerHTML = btn.innerHTML.includes('Show') ? '<i class="bi bi-chevron-up"></i> Show less rating' : '<i class="bi bi-chevron-down"></i> Show more rating';
  }

  // --- LOGIC ---
  function calculateScope() {
    let sumScope = 0;
    document.querySelectorAll('.kva-scope-in').forEach(el => sumScope += Number(el.value || 0));
    const ptw = Number(document.getElementById('cap_ptw').value || 0);
    document.getElementById('out-totalScope').value = sumScope;
    document.getElementById('out-notInScope').value = ptw;

    const installed = Number(document.getElementById('in-installed').value || 0);
    const balance = Math.max(0, sumScope - ptw - installed);
    document.getElementById('out-balanceScope').value = balance;

    const cableReq = Number(document.getElementById('in-cableReq').value || 0);
    const cableInput = document.getElementById('in-cableReq');
    if (cableReq > balance) {
        cableInput.classList.add('val-error');
        document.getElementById('err-cableReq').innerText = `Max allowed: ${balance}`;
    } else {
        cableInput.classList.remove('val-error');
        document.getElementById('err-cableReq').innerText = "";
    }

    const tableSec = document.getElementById('cableDetailsSection');
    // If Cable Req > 0 and input is valid, show table and validate it
    if(cableReq > 0 && !cableInput.classList.contains('val-error')) {
        tableSec.style.display = 'block';
        validateTable(); 
    } else {
        tableSec.style.display = 'none';
    }
    
    validateWithoutCable();
  }

  function validateWithoutCable() {
    const balance = Number(document.getElementById('out-balanceScope').value || 0);
    const woInput = document.getElementById('in-withoutCable');
    if (Number(woInput.value || 0) > balance) {
        woInput.classList.add('val-error');
        document.getElementById('err-withoutCable').innerText = `Cannot exceed Balance (${balance})`;
    } else {
        woInput.classList.remove('val-error');
        document.getElementById('err-withoutCable').innerText = "";
    }
  }

  function validateTable() {
    const globalLimit = Number(document.getElementById('in-cableReq').value || 0);
    let currentSum = 0;
    let lenSum = 0;

    document.querySelectorAll('.cable-dt-count').forEach(input => {
        const count = Number(input.value || 0);
        const kva = input.getAttribute('data-kva');
        const lenInput = document.querySelector(`.cable-len[data-kva="${kva}"]`);
        const totalLen = Number(lenInput.value || 0);
        const avgDisplay = document.getElementById(`avg-${kva}`);
        
        document.getElementById(`mirror-${kva}`).value = count;

        currentSum += count;
        lenSum += totalLen;

        const maxLen = count * 34;
        const avg = count > 0 ? (totalLen / count).toFixed(1) : 0;
        
        if (totalLen > maxLen) {
            lenInput.classList.add('val-error');
            avgDisplay.innerHTML = `<span class="text-danger">${avg}</span><div style="font-size:0.6rem; color:red;">Max 34m/DT</div>`;
        } else {
            lenInput.classList.remove('val-error');
            avgDisplay.innerHTML = (count > 0 && totalLen > 0) ? `<span class="text-success">${avg}</span>` : "0";
        }
    });

    document.getElementById('tbl-sum-count').innerText = currentSum;
    document.getElementById('tbl-sum-len').innerText = lenSum;
    
    const errDiv = document.getElementById('tbl-error-msg');
    // STRICT VALIDATION: If Global Req > 0, Table Sum must match exactly
    if (currentSum !== globalLimit) {
        errDiv.innerText = `Validation Error: Table Total (${currentSum}) must equal Cable Req (${globalLimit})`;
        document.querySelectorAll('.cable-dt-count').forEach(i => i.classList.add('val-error'));
    } else {
        errDiv.innerText = "";
        document.querySelectorAll('.cable-dt-count').forEach(i => i.classList.remove('val-error'));
    }
  }

  async function submitForm() {
    const form = document.getElementById('mainForm');
    
    // 1. Basic Validations
    if(document.querySelector('.val-error')) return alert("Please fix validation errors highlighted in red.");
    if(!payload.signoffBase64 || !payload.sldBase64) return alert("Please upload both images.");

    // 2. Strict Table Validation
    const globalReq = Number(document.getElementById('in-cableReq').value || 0);
    let tableSum = 0;
    document.querySelectorAll('.cable-dt-count').forEach(el => tableSum += Number(el.value || 0));

    if (tableSum !== globalReq) {
        return alert(`Validation Error:\nTable Total (${tableSum}) must match Cable Req (${globalReq}).`);
    }

    // 3. GENERATE JSON PAYLOADS
    
    // A. Scope Breakup JSON (New Requirement)
    const scopeArray = [];
    document.querySelectorAll('.kva-scope-in').forEach(input => {
        const val = Number(input.value || 0);
        // We store all keys even if 0 to maintain full scope structure, or filter >0. 
        // Storing >0 is cleaner for JSON.
        if (val > 0) {
            const kvaName = input.name.replace('cap_', ''); // Extract '10', '16'
            scopeArray.push({ k: kvaName, v: val });
        }
    });

    // B. Cable Details JSON
    const cableDetailsArray = [];
    const cableSummaryArray = [];

    document.querySelectorAll('.cable-dt-count').forEach(input => {
        const count = Number(input.value || 0);
        if(count > 0) {
            const kva = input.getAttribute('data-kva');
            const lenInput = document.querySelector(`.cable-len[data-kva="${kva}"]`);
            const totalLen = Number(lenInput.value || 0);
            
            cableDetailsArray.push({
                k: kva,             
                c: count,           
                s: CABLE_MAP[kva],  
                l: totalLen         
            });
            cableSummaryArray.push(`${kva}KVA: ${count} (${totalLen}m)`);
        }
    });

    // 4. PREPARE FINAL DATA OBJECT
    const data = {
        action: 'submit',
        uploaderName: document.getElementById('uploaderName').value,
        uploaderEmpCode: document.getElementById('activeEmpCode').value,
        zone: form.zone.value, circle: form.circle.value, division: form.division.value,
        subdiv: form.subdiv.value, substation: form.substation.value, feeder: form.feeder.value,
        
        totalScope: document.getElementById('out-totalScope').value,
        totalInstalled: document.getElementById('in-installed').value,
        balanceScope: document.getElementById('out-balanceScope').value,
        notInScope: document.getElementById('out-notInScope').value,
        cableReq: document.getElementById('in-cableReq').value,
        withoutCable: document.getElementById('in-withoutCable').value,
        ptwCount: document.getElementById('cap_ptw').value,
        
        // --- NEW FIELDS ---
        scopeJSON: JSON.stringify(scopeArray),          // Column R
        cableSummary: cableSummaryArray.join(" | ") || "None", // Column S
        cableJSON: JSON.stringify(cableDetailsArray),   // Column T
        
        signoffBase64: payload.signoffBase64,
        sldBase64: payload.sldBase64
    };

    showLoader("Submitting...");
    const res = await apiCall(data);
    hideLoader();

    if(res.status === 'success') {
        alert("Submission Successful!");
        location.reload();
    } else {
        alert("Error: " + res.message);
    }
  }

  async function apiCall(data) {
    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(data)
        });
        return await res.json();
    } catch (e) { return { status: 'error', message: "Network Error" }; }
  }

  async function attemptLogin() {
    const code = document.getElementById('loginEmpCode').value;
    const pass = document.getElementById('loginPass').value;
    showLoader("Authenticating...");
    const res = await apiCall({ action: 'login', empCode: code, password: pass });
    if(res.status === 'success') {
        localStorage.setItem('sld_creds', JSON.stringify({code, pass}));
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('displayUserName').innerText = res.data.name;
        document.getElementById('uploaderName').value = res.data.name;
        document.getElementById('activeEmpCode').value = code;
        loadAppData();
    } else {
        hideLoader();
        document.getElementById('loginMsg').innerText = res.message || "Failed";
    }
  }

  async function loadAppData() {
    showLoader("Loading Data...");
    const res = await fetch(API_URL);
    const json = await res.json();
    hideLoader();
    if(json.status === 'success') {
        masterData = json.data.hierarchy;
        completedFeeders = json.data.completedFeeders;
        populateSelect('sel-zone', 0, []);
    }
  }

  function handleImage(input, key) { if(input.files[0]) { const reader = new FileReader(); reader.onload = e => payload[key] = e.target.result; reader.readAsDataURL(input.files[0]); } }
  function populateSelect(id, idx, filters) { const sel = document.getElementById(id); sel.innerHTML = '<option value="">Select...</option>'; if(!masterData.length) return; const filtered = masterData.filter(r => filters.every((v, i) => v === null || r[i] === v)); const unique = [...new Set(filtered.map(r => r[idx]))].sort(); unique.forEach(val => { const opt = document.createElement('option'); opt.value = val; if(idx === 5 && completedFeeders.includes(val)) { opt.innerText = val + " (‚úÖ Done)"; opt.disabled = true; } else opt.innerText = val; sel.appendChild(opt); }); }
  function filterHierarchy(level) { const vals = ['sel-zone','sel-circle','sel-div','sel-subdiv','sel-substn'].map(id => document.getElementById(id).value || null); if(level === 'zone') { populateSelect('sel-circle', 1, [vals[0]]); clearSelects(['sel-div', 'sel-subdiv', 'sel-substn', 'sel-feeder']); } if(level === 'circle') { populateSelect('sel-div', 2, [vals[0], vals[1]]); clearSelects(['sel-subdiv', 'sel-substn', 'sel-feeder']); } if(level === 'div') { populateSelect('sel-subdiv', 3, [vals[0], vals[1], vals[2]]); clearSelects(['sel-substn', 'sel-feeder']); } if(level === 'subdiv') { populateSelect('sel-substn', 4, [vals[0], vals[1], vals[2], vals[3]]); clearSelects(['sel-feeder']); } if(level === 'substn') { populateSelect('sel-feeder', 5, [vals[0], vals[1], vals[2], vals[3], vals[4]]); } }
  function clearSelects(ids) { ids.forEach(id => document.getElementById(id).innerHTML = '<option value="">Select...</option>'); }
  function showLoader(txt) { document.getElementById('loader').style.display = 'flex'; document.getElementById('loaderText').innerText = txt; }
  function hideLoader() { document.getElementById('loader').style.display = 'none'; }
  function logout() { localStorage.removeItem('sld_creds'); location.reload(); }
</script>
</body>
</html>

