<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SLD Collection Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root { --primary: #0F204B; --secondary: #78BE20; --bg: #f4f7f9; --text-dark: #333; --error: #dc3545; }
    body { background-color: var(--bg); font-family: 'Inter', sans-serif; color: var(--text-dark); padding-bottom: 70px; }
    
    /* Utility Classes */
    .card-custom { background: white; border-radius: 12px; padding: 20px; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 20px; }
    .section-title { font-size: 0.9rem; text-transform: uppercase; color: var(--primary); font-weight: 700; border-bottom: 2px solid #e9ecef; padding-bottom: 8px; margin-bottom: 15px; }
    .form-label { font-size: 0.85rem; font-weight: 500; color: #555; }
    
    /* Overlays */
    .loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.98); z-index: 4000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    
    /* New Cable Table Styles */
    .cable-table-container { background: #f8f9fa; border-radius: 8px; padding: 10px; border: 1px solid #dee2e6; margin-top: 15px; }
    .cable-header { background: #e3f2fd; color: var(--primary); font-weight: 700; font-size: 0.8rem; text-align: center; padding: 10px; border-radius: 5px 5px 0 0; }
    .cable-row { display: grid; grid-template-columns: 0.8fr 0.8fr 1fr 1fr 1fr; gap: 8px; padding: 8px 0; border-bottom: 1px solid #eee; align-items: center; font-size: 0.8rem; }
    .cable-row label { display: block; font-size: 0.7rem; color: #888; margin-bottom: 2px; }
    .cable-row input { text-align: center; font-size: 0.85rem; padding: 4px; }
    .val-error { border-color: var(--error) !important; background-color: #fff8f8; }
    .val-msg { color: var(--error); font-size: 0.7rem; font-weight: 700; display: block; margin-top: 2px; }

    /* Floating Tab Bar */
    .nav-tabs-custom { position: fixed; bottom: 0; left: 0; width: 100%; background: white; z-index: 1000; display: flex; justify-content: space-around; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
    .nav-link-custom { border: none; background: transparent; color: #6c757d; font-weight: 600; padding: 8px 15px; border-radius: 20px; cursor: pointer; }
    .nav-link-custom.active { background-color: var(--primary); color: white; }
  </style>
</head>
<body>

<div id="loader" class="loader-overlay">
  <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
  <div class="fw-bold text-muted" id="loaderText">Connecting to Server...</div>
</div>

<div id="loginScreen" class="overlay">
  <div class="card-custom shadow" style="width: 350px;">
    <div class="text-center mb-4"><h3 class="fw-bold" style="color:var(--primary);">SLD Collection</h3></div>
    <div class="mb-3"><label class="form-label">Emp Code</label><input type="text" id="loginEmpCode" class="form-control"></div>
    <div class="mb-3"><label class="form-label">Password</label><input type="password" id="loginPass" class="form-control"></div>
    <button class="btn btn-primary w-100" onclick="attemptLogin()">Login</button>
    <div id="loginMsg" class="text-danger mt-3 text-center small fw-bold"></div>
  </div>
</div>

<div id="app" style="display:none;" class="container pt-3">
  
  <div class="d-flex justify-content-between align-items-center mb-3">
    <small class="text-muted">User: <span id="displayUserName" class="fw-bold text-dark"></span></small>
    <button class="btn btn-sm btn-outline-danger" onclick="logout()">Logout</button>
  </div>

  <div id="tabForm">
    <form id="mainForm">
      <input type="hidden" id="activeEmpCode"><input type="hidden" id="uploaderName" name="uploaderName">
      
      <div class="card-custom">
        <h6 class="section-title">üìç Location Details</h6>
        <div class="row g-3">
          <div class="col-6"><label class="form-label">Zone</label><select name="zone" id="sel-zone" class="form-select form-select-sm" onchange="filterHierarchy('zone')"></select></div>
          <div class="col-6"><label class="form-label">Circle</label><select name="circle" id="sel-circle" class="form-select form-select-sm" onchange="filterHierarchy('circle')"></select></div>
          <div class="col-6"><label class="form-label">Division</label><select name="division" id="sel-div" class="form-select form-select-sm" onchange="filterHierarchy('div')"></select></div>
          <div class="col-6"><label class="form-label">Sub Div</label><select name="subdiv" id="sel-subdiv" class="form-select form-select-sm" onchange="filterHierarchy('subdiv')"></select></div>
          <div class="col-6"><label class="form-label">Substation</label><select name="substation" id="sel-substn" class="form-select form-select-sm" onchange="filterHierarchy('substn')"></select></div>
          <div class="col-12"><label class="form-label text-primary fw-bold">Feeder</label><select name="feeder" id="sel-feeder" class="form-select"></select></div>
        </div>
      </div>

      <div class="card-custom">
        <h6 class="section-title">‚ö° DT Capacity Breakup</h6>
        <div class="row g-2" id="kvaInputs">
            <div class="col-4">
                <div class="bg-warning-subtle p-2 rounded border border-warning text-center">
                    <label class="small fw-bold text-danger d-block">PTW</label>
                    <input type="number" class="form-control text-center p-1 kva-in" id="cap_ptw" name="cap_ptw" value="0" min="0">
                </div>
            </div>
            </div>
      </div>

      <div class="card-custom">
        <h6 class="section-title">üìä Scope & Status</h6>
        <div class="row g-3">
          <div class="col-6">
            <label class="form-label text-muted">Total Scope</label>
            <input type="number" class="form-control bg-light" id="out-totalScope" value="0" readonly>
          </div>
          <div class="col-6">
            <label class="form-label text-muted">Not In Scope (PTW)</label>
            <input type="number" class="form-control bg-light" id="out-notInScope" value="0" readonly>
          </div>

          <div class="col-6">
            <label class="form-label text-primary">Installed <span class="text-danger">*</span></label>
            <input type="number" class="form-control" name="totalInstalled" id="in-installed" oninput="calculateScope()">
          </div>
          <div class="col-6">
            <label class="form-label text-primary">Cable Req (DTs) <span class="text-danger">*</span></label>
            <input type="number" class="form-control" name="cableReq" id="in-cableReq" oninput="calculateScope(); toggleCableSection()">
            <div id="err-cableReq" class="val-msg"></div>
          </div>

          <div class="col-12"><hr class="my-1"></div>

          <div class="col-6">
            <label class="form-label fw-bold text-success">Balance Scope</label>
            <input type="number" class="form-control fw-bold text-success bg-light" name="balanceScope" id="out-balanceScope" value="0" readonly>
             <small class="text-muted" style="font-size:0.65rem;">(Total - Inst - Cable)</small>
          </div>
          
          <div class="col-6">
            <label class="form-label text-primary">Without Cable <span class="text-danger">*</span></label>
            <input type="number" class="form-control" name="withoutCable" id="in-withoutCable" oninput="validateWithoutCable()">
            <div id="err-withoutCable" class="val-msg"></div>
          </div>
        </div>

        <div id="cableDetailsSection" class="cable-table-container fade-in" style="display:none;">
            <div class="cable-header text-uppercase">2. DT Cable Requirement Details</div>
            <div class="small text-center text-muted mb-2 fst-italic">Max Length allowed: 34m per DT</div>
            
            <div class="cable-row fw-bold bg-white border-bottom">
                <div>Cap (KVA)</div>
                <div>Count</div>
                <div>Size (mm¬≤)</div>
                <div>Length (M)</div>
                <div>Avg (M)</div>
            </div>
            <div id="cableTableBody"></div>
        </div>
      </div>

      <div class="card-custom">
        <h6 class="section-title">üì∑ Proof Documents</h6>
        <div class="mb-3"><label class="form-label">Sign-off Copy <span class="text-danger">*</span></label><input type="file" class="form-control" accept="image/*" onchange="handleImage(this, 'signoffBase64')"></div>
        <div class="mb-3"><label class="form-label">SLD Drawing <span class="text-danger">*</span></label><input type="file" class="form-control" accept="image/*" onchange="handleImage(this, 'sldBase64')"></div>
      </div>

      <button type="button" class="btn btn-primary w-100 py-3 fw-bold shadow-sm mb-5" onclick="submitForm()">Submit Data</button>
    </form>
  </div>
  
  <div class="nav-tabs-custom">
    <button class="nav-link-custom active"><i class="bi bi-ui-checks"></i> Form</button>
  </div>
</div>

<script>
  // ================= CONFIGURATION =================
  // REPLACE THIS URL WITH YOUR DEPLOYED GOOGLE APPS SCRIPT WEB APP URL
  const API_URL = 'https://script.google.com/macros/s/AKfycbwCL0qhkMW9EZvDPCWjKcp1mjKr9Y0BmCNAemItqf6ei4-ap-lV2TNsJiIP1082eT0n/exec'; 
  
  const CABLE_MAP = {
    10:35, 16:35, 25:35, 63:70, 100:120, 160:240, 
    250:400, 315:400, 400:630, 630:1000, 750:1000, 
    800:1000, 1000:1000, 1200:1000, 1500:1000, 2000:1000
  };
  
  let masterData = [], completedFeeders = [], payload = { signoffBase64: null, sldBase64: null };

  // ================= INITIALIZATION =================
  window.onload = function() {
    renderKvaInputs();
    const saved = localStorage.getItem('sld_creds');
    if(saved) {
       const c = JSON.parse(saved);
       document.getElementById('loginEmpCode').value = c.code;
       document.getElementById('loginPass').value = c.pass;
       attemptLogin();
    } else {
       document.getElementById('loader').style.display = 'none';
    }
  };

  function renderKvaInputs() {
    const kvas = [10,16,25,63,100,160,250,315,400,630,750,800,1000,1200,1500,2000];
    const container = document.getElementById('kvaInputs');
    kvas.forEach(k => {
        container.innerHTML += `
        <div class="col-3">
            <div class="text-center">
                <label class="small text-muted d-block" style="font-size:0.7rem;">${k}</label>
                <input type="number" class="form-control text-center p-1 kva-in kva-valid" name="cap_${k}" data-kva="${k}" value="0" oninput="calculateScope()">
            </div>
        </div>`;
    });
  }

  // ================= API HANDLERS =================
  async function apiCall(data) {
    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'text/plain' }, // Avoid OPTIONS preflight issues in GAS
            body: JSON.stringify(data)
        });
        const json = await res.json();
        return json;
    } catch (e) {
        return { status: 'error', message: "Network Error: " + e.message };
    }
  }

  async function attemptLogin() {
    const code = document.getElementById('loginEmpCode').value;
    const pass = document.getElementById('loginPass').value;
    
    showLoader("Authenticating...");
    const res = await apiCall({ action: 'login', empCode: code, password: pass });
    
    if(res.status === 'success') {
        localStorage.setItem('sld_creds', JSON.stringify({code, pass}));
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('displayUserName').innerText = res.data.name;
        document.getElementById('uploaderName').value = res.data.name;
        document.getElementById('activeEmpCode').value = code;
        loadAppData();
    } else {
        hideLoader();
        document.getElementById('loginMsg').innerText = res.message || "Login Failed";
    }
  }

  async function loadAppData() {
    showLoader("Loading Data...");
    const res = await fetch(API_URL); // GET Request
    const json = await res.json();
    hideLoader();
    
    if(json.status === 'success') {
        masterData = json.data.hierarchy;
        completedFeeders = json.data.completedFeeders;
        populateSelect('sel-zone', 0, []);
    }
  }

  // ================= LOGIC & VALIDATION =================
  
  function calculateScope() {
    // 1. Sum Total Scope from KVAs
    let sumScope = 0;
    document.querySelectorAll('.kva-valid').forEach(el => sumScope += Number(el.value || 0));
    const ptw = Number(document.getElementById('cap_ptw').value || 0);
    
    document.getElementById('out-totalScope').value = sumScope;
    document.getElementById('out-notInScope').value = ptw;

    // 2. Get Inputs
    const installed = Number(document.getElementById('in-installed').value || 0);
    const cableReq = Number(document.getElementById('in-cableReq').value || 0);

    // 3. Balance Calculation: Formula = Total - Installed - CableReq
    // First, validate inputs against logical availability
    const availableForCable = sumScope - installed;
    const cableInput = document.getElementById('in-cableReq');
    const errCable = document.getElementById('err-cableReq');
    
    if (cableReq > availableForCable) {
        cableInput.classList.add('val-error');
        errCable.innerText = `Max allowed: ${availableForCable}`;
        // Temporarily treat as 0 for balance calc to avoid negative numbers visuals
        document.getElementById('out-balanceScope').value = sumScope - installed; 
        return; 
    } else {
        cableInput.classList.remove('val-error');
        errCable.innerText = "";
    }

    // Set Balance
    const balance = sumScope - installed - cableReq;
    document.getElementById('out-balanceScope').value = Math.max(0, balance);
    
    // Re-validate "Without Cable" since Balance changed
    validateWithoutCable();
    
    // Refresh Cable Table Rows if capacities changed
    if(document.getElementById('cableDetailsSection').style.display !== 'none') {
        renderCableTable(false); // Update numbers without resetting lengths if possible
    }
  }

  function validateWithoutCable() {
    const balance = Number(document.getElementById('out-balanceScope').value || 0);
    const woInput = document.getElementById('in-withoutCable');
    const woVal = Number(woInput.value || 0);
    const err = document.getElementById('err-withoutCable');

    if (woVal > balance) {
        woInput.classList.add('val-error');
        err.innerText = `Cannot exceed Balance (${balance})`;
    } else {
        woInput.classList.remove('val-error');
        err.innerText = "";
    }
  }

  function toggleCableSection() {
    const count = Number(document.getElementById('in-cableReq').value || 0);
    const sec = document.getElementById('cableDetailsSection');
    if (count > 0 && !document.getElementById('in-cableReq').classList.contains('val-error')) {
        sec.style.display = 'block';
        renderCableTable(true);
    } else {
        sec.style.display = 'none';
    }
  }

  function renderCableTable(reset) {
    const tbody = document.getElementById('cableTableBody');
    if(reset) tbody.innerHTML = '';
    
    // Generate rows for every KVA input that has a value > 0
    // NOTE: This assumes "Cable Required" count is distributed among these KVAs.
    // The user inputs the length.
    
    document.querySelectorAll('.kva-valid').forEach(input => {
        const count = Number(input.value || 0);
        const kva = input.getAttribute('data-kva');
        const size = CABLE_MAP[kva] || '-';
        
        if (count > 0) {
            // Check if row exists
            let row = document.getElementById(`row-kva-${kva}`);
            if (!row) {
                row = document.createElement('div');
                row.className = 'cable-row bg-white';
                row.id = `row-kva-${kva}`;
                row.innerHTML = `
                    <div class="fw-bold">${kva}</div>
                    <div class="text-center">${count}</div>
                    <div class="text-center small text-muted">${size}</div>
                    <div><input type="number" class="form-control form-control-sm cable-len-in" data-count="${count}" oninput="validateLen(this)"></div>
                    <div class="text-center fw-bold text-success avg-disp">-</div>
                `;
                tbody.appendChild(row);
            } else {
                // Update Count if changed
                row.children[1].innerText = count;
                // Re-trigger validation
                validateLen(row.querySelector('input'));
            }
        } else {
            // Remove row if count became 0
            const row = document.getElementById(`row-kva-${kva}`);
            if(row) row.remove();
        }
    });
  }

  function validateLen(input) {
    const totalLen = Number(input.value || 0);
    const count = Number(input.getAttribute('data-count'));
    const maxLen = count * 34;
    const avg = count > 0 ? (totalLen / count).toFixed(1) : 0;
    
    const avgDisplay = input.parentElement.nextElementSibling;
    
    if (totalLen > maxLen) {
        input.classList.add('val-error');
        // Show red warning format like image
        avgDisplay.innerHTML = `<span class="text-danger">${avg}</span><div style="font-size:0.6rem; color:red;">Max 34m allowed</div>`;
    } else {
        input.classList.remove('val-error');
        avgDisplay.innerHTML = avg;
        avgDisplay.classList.add('text-success');
    }
  }

  // ================= SUBMISSION =================
  async function submitForm() {
    const form = document.getElementById('mainForm');
    
    // Check Frontend Validations
    if(document.querySelector('.val-error')) return alert("Please fix validation errors highlighted in red.");
    if(!payload.signoffBase64 || !payload.sldBase64) return alert("Please upload both images.");
    
    // Build Data Object
    const data = {
        action: 'submit',
        uploaderName: document.getElementById('uploaderName').value,
        uploaderEmpCode: document.getElementById('activeEmpCode').value,
        zone: form.zone.value, circle: form.circle.value, division: form.division.value,
        subdiv: form.subdiv.value, substation: form.substation.value, feeder: form.feeder.value,
        
        totalScope: document.getElementById('out-totalScope').value,
        totalInstalled: document.getElementById('in-installed').value,
        balanceScope: document.getElementById('out-balanceScope').value,
        notInScope: document.getElementById('out-notInScope').value,
        cableReq: document.getElementById('in-cableReq').value,
        withoutCable: document.getElementById('in-withoutCable').value,
        
        signoffBase64: payload.signoffBase64,
        sldBase64: payload.sldBase64
    };

    // Add Caps
    document.querySelectorAll('.kva-in').forEach(i => {
        data[i.name] = i.value;
    });

    showLoader("Submitting Data...");
    const res = await apiCall(data);
    hideLoader();

    if(res.status === 'success') {
        alert("Success! Data submitted.");
        location.reload();
    } else {
        alert("Submission Failed: " + res.message);
    }
  }

  // ================= HELPERS =================
  function handleImage(input, key) {
    if(input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => payload[key] = e.target.result;
        reader.readAsDataURL(input.files[0]);
    }
  }
  
  function populateSelect(id, idx, filters) {
    const sel = document.getElementById(id); sel.innerHTML = '<option value="">Select...</option>';
    if(!masterData.length) return;
    
    const filtered = masterData.filter(r => filters.every((v, i) => v === null || r[i] === v));
    const unique = [...new Set(filtered.map(r => r[idx]))].sort();
    
    unique.forEach(val => {
       const opt = document.createElement('option'); opt.value = val;
       if(idx === 5 && completedFeeders.includes(val)) { 
           opt.innerText = val + " (‚úÖ Done)"; opt.disabled = true; 
       } else opt.innerText = val;
       sel.appendChild(opt);
    });
  }

  function filterHierarchy(level) {
    const vals = ['sel-zone','sel-circle','sel-div','sel-subdiv','sel-substn'].map(id => document.getElementById(id).value || null);
    
    if(level === 'zone') { populateSelect('sel-circle', 1, [vals[0]]); clearSelects(['sel-div', 'sel-subdiv', 'sel-substn', 'sel-feeder']); }
    if(level === 'circle') { populateSelect('sel-div', 2, [vals[0], vals[1]]); clearSelects(['sel-subdiv', 'sel-substn', 'sel-feeder']); }
    if(level === 'div') { populateSelect('sel-subdiv', 3, [vals[0], vals[1], vals[2]]); clearSelects(['sel-substn', 'sel-feeder']); }
    if(level === 'subdiv') { populateSelect('sel-substn', 4, [vals[0], vals[1], vals[2], vals[3]]); clearSelects(['sel-feeder']); }
    if(level === 'substn') { populateSelect('sel-feeder', 5, [vals[0], vals[1], vals[2], vals[3], vals[4]]); }
  }
  
  function clearSelects(ids) { ids.forEach(id => document.getElementById(id).innerHTML = '<option value="">Select...</option>'); }
  function showLoader(txt) { document.getElementById('loader').style.display = 'flex'; document.getElementById('loaderText').innerText = txt; }
  function hideLoader() { document.getElementById('loader').style.display = 'none'; }
  function logout() { localStorage.removeItem('sld_creds'); location.reload(); }
</script>
</body>
</html>
